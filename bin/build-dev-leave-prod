#!/usr/bin/env bash

CURRENT_BUILD_TIME_MAX=20

###
# Helper functions
##
function info () {
	printf "\r  [ \033[00;34m..\033[0m ] %s\n" "$1"
}

function success() {
	printf "\r\033[2K  [ \033[00;32mOK\033[0m ] %s\n" "$1"
}

function warn() {
  printf "\r\033[2K  [\033[0;31mWARN\033[0m] %s\n" "$1"
}

function sub_warn() {
  printf "\r\033[2K  [\033[0;31mWARN\033[0m] \t%s\n" "$1"
}

# Some source used from the sample .pre-commit files by the golang team,
# at https://tip.golang.org/misc/git/pre-commit

# Generates the development static site
# We require this hack since we can't build
# with `JEKYLL_ENV=development jekyll build`
# since Jekyll is retarded.
info "Serve: Starting a Jekyll server in the background"
bundle exec jekyll serve &
jekyll_pid=$!
info "Serve: Jekyll server has started in the background"

# Sleeps for a bit while the site is building.
# NOTE: This value will need to be changed
# to be greater than the current required
# build time

sleep $CURRENT_BUILD_TIME_MAX

# Runs through the test suite
if bin/test ; then
    success "Test: All tests passed correctly"
else
    warn "Test: Some tests failed to pass"
    exit 1
fi

export jekyll_pid